<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anurag University Chatbot UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Lucide Icons as separate script -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    
    <style>
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Loading animation */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .bounce-dot {
            animation: bounce 1s infinite;
        }
        .bounce-dot:nth-child(2) {
            animation-delay: 0.1s;
        }
        .bounce-dot:nth-child(3) {
            animation-delay: 0.2s;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Debug: Check if libraries are loaded
        console.log('React:', typeof React);
        console.log('ReactDOM:', typeof ReactDOM);
        console.log('lucideReact:', typeof lucideReact);
        
        // Get React hooks
        const { useState, useRef, useEffect } = React;
        
        // Safely get Lucide icons with fallback
        let Send, Menu, MessageSquare, Briefcase, GraduationCap, DollarSign, Home;
        
        if (typeof lucideReact !== 'undefined') {
            ({ 
                Send, 
                Menu, 
                MessageSquare, 
                Briefcase, 
                GraduationCap, 
                DollarSign, 
                Home 
            } = lucideReact);
        } else {
            // Fallback: Create simple div elements if icons fail to load
            console.warn('Lucide icons not loaded, using fallback');
            const createFallbackIcon = (name) => () => React.createElement('div', { 
                className: 'w-5 h-5 bg-current rounded'
            });
            Send = createFallbackIcon('Send');
            Menu = createFallbackIcon('Menu');
            MessageSquare = createFallbackIcon('MessageSquare');
            Briefcase = createFallbackIcon('Briefcase');
            GraduationCap = createFallbackIcon('GraduationCap');
            DollarSign = createFallbackIcon('DollarSign');
            Home = createFallbackIcon('Home');
        }

        // Main App Component
        const App = () => {
            console.log('App component rendering...');
            
            const [messages, setMessages] = useState([
                { 
                    text: "Hello! I am the Anurag University Assistant. I can help you with Admissions, Academics, Placements, and Facilities. How can I assist you today?", 
                    sender: 'bot',
                    timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                }
            ]);
            const [inputMessage, setInputMessage] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const chatEndRef = useRef(null);

            // Scroll to bottom
            const scrollToBottom = () => {
                if (chatEndRef.current) {
                    chatEndRef.current.scrollIntoView({ behavior: "smooth" });
                }
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // API configuration
            const getApiUrl = () => {
                const isLocal = window.location.hostname === 'localhost' || 
                              window.location.hostname === '127.0.0.1' ||
                              window.location.hostname === '';
                return isLocal ? 'http://127.0.0.1:8000/chat' : '/chat';
            };

            // Send message function
            const handleSendMessage = async (textToSend = inputMessage) => {
                if (!textToSend.trim() || isLoading) return;

                // Add user message
                const userMessage = { 
                    text: textToSend, 
                    sender: 'user', 
                    timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) 
                };
                setMessages(prev => [...prev, userMessage]);
                setInputMessage('');
                setIsLoading(true);

                try {
                    const response = await fetch(getApiUrl(), {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ text: textToSend })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    const botMessage = {
                        text: data.response || "I'm still learning about Anurag University. Please try asking about Admissions, Placements, Academics, or Facilities.",
                        sender: 'bot',
                        timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                    };
                    setMessages(prev => [...prev, botMessage]);

                } catch (error) {
                    console.error("API Error:", error);
                    const errorMessage = {
                        text: "I'm having trouble connecting right now. Please make sure the backend server is running on port 8000.",
                        sender: 'bot',
                        timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                    };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };

            // Quick links
            const quickLinks = [
                { icon: DollarSign, text: "B.Tech Fee", query: "What is the tuition fee for B.Tech?" },
                { icon: GraduationCap, text: "UG Programs", query: "What courses are offered for undergraduate?" },
                { icon: Briefcase, text: "Avg Salary", query: "What is the average placement salary?" },
                { icon: Home, text: "Hostel Fee", query: "How much is the hostel fee for boys?" },
            ];

            // Handle Enter key press
            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };

            return React.createElement('div', { 
                className: 'flex flex-col h-full bg-gray-50'
            }, [
                // Header
                React.createElement('header', {
                    key: 'header',
                    className: 'flex items-center justify-between p-4 bg-indigo-600 text-white shadow-md'
                }, [
                    React.createElement('div', {
                        key: 'header-left',
                        className: 'flex items-center space-x-3'
                    }, [
                        MessageSquare ? React.createElement(MessageSquare, { 
                            key: 'icon',
                            className: 'w-6 h-6'
                        }) : null,
                        React.createElement('h1', {
                            key: 'title',
                            className: 'text-xl font-bold'
                        }, 'Anurag UniBot Assistant')
                    ]),
                    Menu ? React.createElement(Menu, {
                        key: 'menu',
                        className: 'w-6 h-6 md:hidden cursor-pointer'
                    }) : null
                ]),

                // Main Content
                React.createElement('div', {
                    key: 'main',
                    className: 'flex-1 flex flex-col md:flex-row overflow-hidden'
                }, [
                    // Sidebar (Desktop only)
                    React.createElement('aside', {
                        key: 'sidebar',
                        className: 'hidden md:flex w-full md:w-1/4 bg-white border-r border-gray-200 p-4 flex-col space-y-4'
                    }, [
                        React.createElement('h2', {
                            key: 'sidebar-title',
                            className: 'text-lg font-semibold text-gray-800 border-b pb-2 mb-2'
                        }, 'Quick Questions'),
                        
                        ...quickLinks.map((link, index) => 
                            React.createElement('button', {
                                key: `link-${index}`,
                                onClick: () => handleSendMessage(link.query),
                                disabled: isLoading,
                                className: 'flex items-center w-full px-3 py-2 text-left text-sm font-medium text-indigo-700 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition duration-150 disabled:opacity-50'
                            }, [
                                link.icon ? React.createElement(link.icon, {
                                    key: 'icon',
                                    className: 'w-5 h-5 mr-3 flex-shrink-0'
                                }) : null,
                                link.text
                            ])
                        ),
                        
                        React.createElement('p', {
                            key: 'language-note',
                            className: 'pt-4 text-xs text-gray-500 italic'
                        }, 'Try asking in Hindi or Telugu!\n(e.g., "హాస్టల్ ఫీజు ఎంత?")')
                    ]),

                    // Chat Area
                    React.createElement('main', {
                        key: 'chat',
                        className: 'flex-1 flex flex-col p-4'
                    }, [
                        // Messages Container
                        React.createElement('div', {
                            key: 'messages',
                            className: 'flex-1 overflow-y-auto space-y-4 p-4 bg-white rounded-lg shadow-inner max-w-4xl mx-auto'
                        }, [
                            ...messages.map((message, index) =>
                                React.createElement('div', {
                                    key: `msg-${index}`,
                                    className: `flex ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`
                                }, 
                                React.createElement('div', {
                                    className: `max-w-xs md:max-w-md px-4 py-3 rounded-2xl shadow ${
                                        message.sender === 'user' 
                                            ? 'bg-indigo-500 text-white rounded-br-none' 
                                            : 'bg-white border border-gray-200 text-gray-800 rounded-tl-none'
                                    }`
                                }, [
                                    React.createElement('p', {
                                        key: 'text',
                                        className: 'text-sm leading-relaxed whitespace-pre-wrap'
                                    }, message.text),
                                    React.createElement('span', {
                                        key: 'time',
                                        className: `block mt-1 text-right text-xs ${
                                            message.sender === 'user' ? 'text-indigo-200' : 'text-gray-400'
                                        }`
                                    }, message.timestamp)
                                ]))
                            ),
                            
                            // Loading indicator
                            isLoading && React.createElement('div', {
                                key: 'loading',
                                className: 'flex justify-start'
                            }, 
                            React.createElement('div', {
                                className: 'bg-white border border-gray-200 text-gray-600 px-4 py-3 rounded-2xl rounded-tl-none shadow'
                            }, 
                            React.createElement('div', {
                                className: 'flex space-x-1'
                            }, [
                                React.createElement('div', {
                                    key: 'dot1',
                                    className: 'w-2 h-2 bg-gray-400 rounded-full bounce-dot'
                                }),
                                React.createElement('div', {
                                    key: 'dot2',
                                    className: 'w-2 h-2 bg-gray-400 rounded-full bounce-dot'
                                }),
                                React.createElement('div', {
                                    key: 'dot3',
                                    className: 'w-2 h-2 bg-gray-400 rounded-full bounce-dot'
                                })
                            ]))),
                            
                            React.createElement('div', {
                                key: 'scroll-anchor',
                                ref: chatEndRef
                            })
                        ]),

                        // Input Area
                        React.createElement('div', {
                            key: 'input',
                            className: 'mt-4 pt-4 border-t border-gray-200 max-w-4xl mx-auto w-full'
                        }, 
                        React.createElement('div', {
                            className: 'flex space-x-3'
                        }, [
                            React.createElement('input', {
                                key: 'input-field',
                                type: 'text',
                                value: inputMessage,
                                onChange: (e) => setInputMessage(e.target.value),
                                onKeyPress: handleKeyPress,
                                disabled: isLoading,
                                placeholder: 'Ask about Admissions, Placements, Academics...',
                                className: 'flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100'
                            }),
                            React.createElement('button', {
                                key: 'send-btn',
                                onClick: () => handleSendMessage(),
                                disabled: !inputMessage.trim() || isLoading,
                                className: 'p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 flex items-center justify-center'
                            }, 
                            isLoading ? 
                                React.createElement('div', {
                                    className: 'animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full'
                                }) :
                                (Send ? React.createElement(Send, { className: 'w-5 h-5' }) : 'Send')
                            )
                        ]))
                    ])
                ])
            ]);
        };

        // Render the app
        console.log('Starting React render...');
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(App));
            console.log('React app rendered successfully!');
        } catch (error) {
            console.error('React render error:', error);
            document.getElementById('root').innerHTML = `
                <div class="p-4 text-red-600">
                    <h2>Error Loading Chatbot</h2>
                    <p>${error.message}</p>
                    <p>Check browser console for details.</p>
                </div>
            `;
        }
    </script>
</body>
</html>